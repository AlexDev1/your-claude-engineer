Выполни следующую задачу для команды: {team}
Рабочая директория: {cwd}
Фильтр по проекту: {project}

## РЕЖИМ ПРОДОЛЖЕНИЯ

### 0. Загрузить предыдущий контекст
task agent: Получить комментарии META-задачи, найти последний "Session Summary"
Вернуть: что было сделано, ошибки, файлы, следующий шаг, контекст

Использовать для: возобновления работы, пропуска проанализированных файлов, избежания неудачных подходов.

### 0.1 Проверить прерванную сессию (ENG-29)
Проверь .agent/MEMORY.md на наличие записи "Context Limit Shutdown".
Если найдена:
- Запомни ID прерванной задачи и шаг
- Возобнови с этого точного шага, не начинай с нуля
- Предыдущая работа всё ещё актуальна, просто продолжай

## Процесс

### 1. Получить задачу
task agent: Список Todo и In Progress для {team} с project={project}, limit=10
- Если In Progress: возобнови её (проверь, было ли прерывание по лимиту контекста)
- Иначе: Todo с наивысшим приоритетом
**ВАЖНО: Всегда используй project={project} и limit=10 в Task_ListIssues.**

Если нет Todo/In Progress: telegram ":tada: Всё выполнено!" затем `ALL_TASKS_DONE:` и остановиться.

### 1.5 Проверить наличие Epic (ENG-27)

После получения задачи проверь, является ли она Epic (декомпозированная задача):
- Ищи комментарий начинающийся с "Epic: This task has been decomposed"
- Если найден, извлеки ID подзадач из комментария

**Если задача -- Epic:**
1. Перечисли все ID подзадач из комментария Epic
2. Проверь статус каждой подзадачи через task agent
3. Найди первую подзадачу НЕ в статусе Done
4. Если все подзадачи Done:
   - Отметь Epic как Done
   - telegram: ":white_check_mark: Epic завершён: [title]"
   - Вернись к Шагу 1 для следующей задачи
5. Если найдена незавершённая подзадача:
   - Сообщи прогресс Epic: "Epic [id]: 3/5 подзадач выполнено"
   - Продолжи с незавершённой подзадачей как текущей

**Если задача -- НЕ Epic:**
- Проверь, является ли задача большой (смотри evaluate_task.md Шаг 1.5)
- Если большая и ещё не декомпозирована: декомпозируй
- Иначе: продолжай нормально

### 2. Начало
task agent: Перевести в In Progress (если нужно)
telegram: ":construction: Начинаю: [title]" или ":repeat: Возобновляю: [title]"
coding agent: Создать или переключиться на ветку `agent/{{issue-id}}`

### 3. Реализация
coding agent с ПОЛНЫМ контекстом + предыдущий контекст:
- ID, Заголовок, Описание, Шаги тестирования
- Предыдущий контекст (при возобновлении)
- Прерванный шаг (при восстановлении после лимита контекста)

**Если активен КОМПАКТНЫЙ РЕЖИМ (70%+ контекста):**
- Используй только: ID + Заголовок + 1 строка описания
- Пропусти просмотр истории META-задачи
- Передай минимальный контекст coding agent

### 4. Коммит
coding agent: Коммит с ID задачи

### 4a. Пуш (ENG-62)
coding agent: После прохождения линтинг-гейта, пуш на remote:
- Запусти `./scripts/lint-gate.sh`
- Если прошёл: `git push -u origin agent/{{issue-id}}`
- Если не прошёл: исправь ошибки линтинга, перекоммить, перезапусти линтинг-гейт
- Если GITHUB_TOKEN не задан: пропустить пуш тихо

### 4b. Гейт ревью кода (ENG-42)
Смотри раздел "Гейт ревью" в orchestrator_prompt.md для полных правил.
- Авто-одобрение: только документация, только конфиг, или <20 строк
- Иначе: reviewer agent проверяет diff, максимум 2 цикла ревью

### 5. Отметить Done
task agent: Отметить Done с файлами/доказательствами верификации

### 6. Уведомить
telegram: ":white_check_mark: Завершено: [title]"

### 7. Память
coding agent: Обновить .agent/MEMORY.md
task agent: Итоги сессии в META-задачу

## Восстановление после лимита контекста (ENG-29)

Если сессия была прервана из-за лимита контекста:
1. Проверь MEMORY.md на наличие записи "Context Limit Shutdown"
2. Найди шаг interrupted_at
3. Возобнови с этого шага (не переделывай завершённую работу)
4. Задача скорее всего всё ещё в In Progress

Пример записи в MEMORY.md:
```
### Context Limit Shutdown (2024-01-15T10:30:00)
- Issue: ENG-29
- Interrupted at: step_implement
- Resume from step: implement
```

## Правила
- Сначала проверь предыдущий контекст
- Проверь прерывание по лимиту контекста
- Не отмечать Done без верификации (browser_snapshot, тесты или lint-gate)
- Одна задача за сессию
- Сброс памяти перед завершением
- В КОМПАКТНОМ РЕЖИМЕ: только минимальный контекст
- **НИКОГДА не создавать проекты** (Task_CreateProject ЗАПРЕЩЁН). Работать только в project={project}
- Все новые задачи (подзадачи декомпозиции) ОБЯЗАНЫ использовать project={project}
