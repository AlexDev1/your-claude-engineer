Выполни следующую задачу для команды: {team}
Рабочая директория: {cwd}
Фильтр по проекту: {project}

## Процесс

### 1. Получить задачу
task agent: "Список Todo-задач для {team} с project={project}, limit=10, вернуть задачу с наивысшим приоритетом (urgent>high>medium>low). ВАЖНО: всегда используй project={project} и limit=10."

Если нет Todo: telegram ":tada: Все задачи выполнены!" затем вывести `ALL_TASKS_DONE:` и остановиться.

### 1.5 Оценка размера задачи (ENG-27)

Проверь, является ли задача большой, на основе:
- **Ключевые слова**: "create service", "build dashboard", "implement pipeline", "full", "complete", "entire", "web app", "API server", "new project"
- **Масштаб**: Множество компонентов, ожидается 5+ файлов, оценка 300+ строк

**Если большая задача -- декомпозиция:**
1. Проанализируй описание задачи, разбей на 3-7 логических подзадач
2. Создай каждую подзадачу через task agent (Task_CreateIssue):
   - Заголовок: "[Заголовок родителя]: [Описание подзадачи]"
   - Приоритет: Такой же как у родителя
   - Проект: {project} (ОБЯЗАН совпадать с проектом родителя)
   - Описание: Конкретный объём для данной подзадачи
3. Добавь комментарий к исходной задаче:
   ```
   Epic: This task has been decomposed into subtasks:
   - [subtask-id-1]: [title]
   - [subtask-id-2]: [title]
   ...
   Will mark Done when all subtasks complete.
   ```
4. Продолжи с первой подзадачей как текущей

**Пример декомпозиции:**
```
Оригинал: "Build Web Dashboard" (ENG-50)
Созданные подзадачи:
- ENG-51: "Build Web Dashboard: REST API endpoints"
- ENG-52: "Build Web Dashboard: React project setup"
- ENG-53: "Build Web Dashboard: Projects list page"
- ENG-54: "Build Web Dashboard: Kanban board component"
- ENG-55: "Build Web Dashboard: Docker integration"
```

**Если маленькая/средняя задача:** Переходи к Шагу 2 (декомпозиция не нужна).

### 2. Начало
task agent: Перевести в In Progress
telegram: ":construction: Начинаю: [title] ([id])"
coding agent: Создать ветку `agent/{{issue-id}}` (например, `git checkout -b agent/eng-62`)

### 3. Реализация
coding agent с ПОЛНЫМ контекстом:
- ID, Заголовок, Описание, Шаги тестирования
- Требования: прочитать код, реализовать, тест Playwright, верификация browser_snapshot

**Если активен КОМПАКТНЫЙ РЕЖИМ (70%+ контекста):**
- Используй только: ID + Заголовок + 1 строка описания
- Пропусти подробные требования
- Передай минимальный контекст coding agent

### 3b. Гейт ревью кода (ENG-42)
Смотри раздел "Гейт ревью" в orchestrator_prompt.md для полных правил.
- Авто-одобрение: только документация, только конфиг, или <20 строк
- Иначе: reviewer agent проверяет diff, максимум 2 цикла ревью

### 4. Коммит
coding agent: Коммит с ID задачи

### 4b. Пуш (ENG-62)
coding agent: После прохождения линтинг-гейта, пуш на remote:
- Запусти `./scripts/lint-gate.sh`
- Если прошёл: `git push -u origin agent/{{issue-id}}`
- Если не прошёл: исправь ошибки линтинга, перекоммить, перезапусти линтинг-гейт
- Если GITHUB_TOKEN не задан: пропустить пуш тихо

### 5. Отметить Done
task agent: Отметить Done с файлами/доказательствами верификации/результатами

### 6. Уведомить
telegram: ":white_check_mark: Завершено: [title]"

### 7. Память
coding agent: Обновить .agent/MEMORY.md
task agent: Добавить итоги сессии в META-задачу

## Режим восстановления (ENG-69)

Когда раздел `## Recovery Mode` добавлен к этому промпту, агент возобновляет работу
после крэша или прерванной сессии. Следуй этим правилам:

1. **Пропусти завершённые фазы.** В разделе восстановления перечислены уже успешные фазы.
   НЕ повторяй их.
2. **Возобнови с указанной фазы.** Поле `resume_phase` указывает точно, откуда продолжить.
3. **Сначала проверь состояние git.** Если указан `uncommitted_changes`, запусти `git status` и
   `git diff` перед написанием кода. Реши: закоммитить, stash или отбросить.
4. **Поздние фазы (commit, mark_done, notify, flush):** Код уже написан.
   НЕ реализуй заново. Только повтори неудавшуюся операцию.
5. **Получи детали задачи.** Используй `issue_id` из контекста восстановления для получения задачи
   и продолжения с того места, где остановилась предыдущая сессия.
6. **Деградированные сервисы.** Если сервисы отмечены как деградированные, пропусти эти интеграции
   (например, пропусти Telegram-уведомление если `notify` деградирован).

## Правила
- Не отмечать Done без верификации (browser_snapshot, тесты или lint-gate)
- Передавай ПОЛНЫЙ контекст coding agent (если не КОМПАКТНЫЙ РЕЖИМ)
- Одна задача за сессию
- Сброс памяти перед завершением
- Если использовано 85%+ контекста: вывести `CONTEXT_LIMIT_REACHED:` для плавного завершения
- **НИКОГДА не создавать проекты** (Task_CreateProject ЗАПРЕЩЁН). Работать только в project={project}
- Все новые задачи (подзадачи декомпозиции) ОБЯЗАНЫ использовать project={project}
