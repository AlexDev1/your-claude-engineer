# CLAUDE.md
**ВАЖНО**: вы всегда должны отвечать на русском языке!
Этот файл предоставляет руководство для Claude Code (claude.ai/code) при работе с кодом в этом репозитории.

## Обзор

Это автономная оболочка AI агента, построенная на Claude Agent SDK. Она запускает задаче-ориентированные сессии кодирования с использованием мультиагентной оркестрации со специализированными субагентами для управления задачами, кодирования (реализация с Playwright тестированием и Git) и Telegram (уведомления).

Агент работает в текущей директории (cwd), выбирает задачи из Task MCP Server по приоритету и выполняет их одну за другой пока не останется задач.

**Важно**: Это оболочка/фреймворк для запуска автономных агентов, а не традиционное приложение.

**MCP серверы**: Развёрнуты отдельно — см. [AxonCode/axon-mcp](https://github.com/AxonCode/axon-mcp) для развёртывания Task и Telegram MCP серверов.

## Команды

```bash
# Настройка
pip install -r requirements.txt

# Запуск агента (работает в текущей директории)
uv run python autonomous_agent_demo.py
uv run python autonomous_agent_demo.py --team ENG
uv run python autonomous_agent_demo.py --team ENG --max-iterations 3 --model opus

# Тест хуков безопасности
uv run python test_security.py
```

## Архитектура

```
ОРКЕСТРАТОР (координирует работу, делегирует субагентам через Task tool)
    ├── TASK AGENT        → Управление задачами, приоритезация (через Task MCP Server)
    ├── CODING AGENT      → Реализация + Playwright UI тестирование + Git коммиты
    └── TELEGRAM AGENT    → Уведомления о прогрессе (через Telegram MCP Server)
```

**Ключевые файлы**:
- `autonomous_agent_demo.py` - Основная точка входа, парсинг CLI аргументов
- `agent.py` - Раннер сессии (`run_agent_session()`, `run_autonomous_agent()`)
- `client.py` - Настройка SDK клиента с MCP серверами и настройками безопасности
- `mcp_config.py` - URL MCP серверов и определения инструментов
- `security.py` - Allowlist Bash команд и хуки валидации
- `prompts/` - Все системные промпты агентов и шаблоны задач
- `prompts/execute_task.md` - Промпт задачи на итерацию (получить следующую задачу, реализовать, отметить выполненной)

**Задаче-ориентированный цикл**: Каждую итерацию агент получает следующую Todo задачу по приоритету, реализует её и отмечает как Done. Когда не остаётся задач, агент выводит `ALL_TASKS_DONE:` и останавливается.

## Ключевые паттерны

1. **Паттерн оркестратора**: Основной агент делегирует специализированным субагентам, передавая контекст между ними
2. **Изоляция сессии**: Свежие сессии агента на каждой итерации для избежания исчерпания контекстного окна
3. **Выполнение на основе приоритета**: Задачи выбираются по приоритету (urgent > high > medium > low)
4. **Скриншот-доказательство**: Все функции требуют скриншот-доказательства перед отметкой Done

## Модель безопасности (Глубокая защита)

- **MCP аутентификация**: OAuth 2.0 + API ключи обрабатываются MCP серверами (см. [axon-mcp](https://github.com/AxonCode/axon-mcp))
- Песочница на уровне ОС для bash команд
- Файловая система ограничена директорией проекта
- Allowlist Bash команд в `security.py` (набор `ALLOWED_COMMANDS`)
- Хук валидации до выполнения (`bash_security_hook()`)
- MCP разрешения явно настроены

## Точки кастомизации

- **Разрешённые bash команды**: Добавьте в `ALLOWED_COMMANDS` в `security.py`
- **Поведение агента**: Отредактируйте соответствующий промпт в `prompts/`
- **Модели**: Установите переменные окружения (`ORCHESTRATOR_MODEL`, `CODING_AGENT_MODEL` и т.д.) или используйте флаг `--model`
- **Команда**: Используйте флаг `--team` (по умолчанию: ENG)

## Предварительные требования

### MCP серверы

Разверните Task и Telegram MCP серверы из [AxonCode/axon-mcp](https://github.com/AxonCode/axon-mcp), затем настройте URL в `.env`:

```
TASK_MCP_URL=https://mcp.yourdomain.com/task/sse
TELEGRAM_MCP_URL=https://mcp.yourdomain.com/telegram/sse
MCP_API_KEY=mcp_your_api_key
```

## Ограничения

- **Windows не поддерживается** (субагенты требуют Linux/macOS; WSL работает)
- Bash heredocs заблокированы (используйте Write tool вместо этого)
