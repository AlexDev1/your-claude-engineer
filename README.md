# Your Claude Engineer

**Ваш собственный AI-инженер, который управляет проектами, пишет код и сообщает о прогрессе — автономно.**

Когда-нибудь хотели передать задачу на разработку и получить её полностью реализованной, протестированной и задокументированной? Your Claude Engineer — это фреймворк для длительных задач на базе [Claude Agent SDK](https://github.com/anthropics/claude-code/tree/main/agent-sdk-python), который превращает Claude в долго работающего инженера, способного решать сложные многоэтапные задачи.

Полный рабочий процесс разработки с использованием субагентов:

- **Управление проектом**: Создаёт и отслеживает работу через самохостируемый Task MCP Server (бэкенд на PostgreSQL), разбивает фичи на задачи и обновляет статусы
- **Реализация кода**: Пишет, тестирует и итерирует код с UI-верификацией через Playwright
- **Контроль версий**: Коммитит изменения в локальный git-репозиторий
- **Коммуникация**: Информирует о прогрессе через Telegram

Мультиагентная архитектура использует специализированных агентов (Task, Coding, Telegram), координируемых оркестратором, что позволяет проводить длительные автономные сессии без исчерпания контекстного окна.

## Ключевые возможности

- **Длительная автономность**: Архитектура позволяет проводить расширенные сессии кодинга
- **Мультиагентная оркестрация**: Специализированные агенты отвечают за отдельные задачи
- **Самохостируемое управление задачами**: PostgreSQL-бэкенд с полным контролем над данными
- **Локальный Git**: Автоматические коммиты с описательными сообщениями
- **Уведомления в Telegram**: Обновления прогресса в личный чат
- **Браузерное тестирование**: Playwright MCP для автоматической UI-верификации
- **Конфигурация моделей**: Выбор модели для каждого агента (Haiku, Sonnet или Opus)
- **OAuth 2.0 + API Key аутентификация**: Двойная поддержка — OAuth 2.0 для Claude.ai и Bearer API-ключи для Claude Code

## Требования

> Не работает на Windows из-за ограничений Claude Agent SDK и субагентов. Используйте WSL или Linux VM!

### 0. Создание виртуального окружения Python (рекомендуется)

```bash
# Создание виртуального окружения
python3 -m venv venv

# Активация
source venv/bin/activate  # На macOS/Linux
```

### 1. Установка Claude Code CLI и Python SDK

```bash
# Установка Claude Code CLI (требуется последняя версия)
npm install -g @anthropic-ai/claude-code

# Установка Python-зависимостей
pip install -r requirements.txt
```

### 2. Развёртывание MCP серверов

MCP серверы (Task + Telegram) развёрнуты в отдельном репозитории: **[AxonCode/axon-mcp](https://github.com/AxonCode/axon-mcp)**

Следуйте инструкциям в axon-mcp для деплоя серверов на ваш VDS, затем вернитесь сюда для настройки агента.

### 3. Настройка локального окружения

```bash
# Скопируйте пример файла окружения
cp .env.example .env

# Отредактируйте .env с URL ваших MCP серверов и API ключом:
# - TASK_MCP_URL: https://mcp.yourdomain.com/task/sse
# - TELEGRAM_MCP_URL: https://mcp.yourdomain.com/telegram/sse
# - MCP_API_KEY: mcp_your_api_key
```

<details>
<summary><strong>Справочник переменных окружения</strong></summary>

| Переменная | Описание | Обязательна |
|------------|----------|-------------|
| `TASK_MCP_URL` | URL вашего Task MCP Server | Да |
| `TELEGRAM_MCP_URL` | URL вашего Telegram MCP Server | Да |
| `MCP_API_KEY` | API ключ для аутентификации MCP серверов | Да |
| `GENERATIONS_BASE_PATH` | Базовая директория для генерируемых проектов (по умолчанию: ./generations) | Нет |
| `ORCHESTRATOR_MODEL` | Модель для оркестратора: haiku, sonnet, opus (по умолчанию: haiku) | Нет |
| `TASK_AGENT_MODEL` | Модель для Task агента (по умолчанию: haiku) | Нет |
| `CODING_AGENT_MODEL` | Модель для Coding агента (по умолчанию: sonnet) | Нет |
| `TELEGRAM_AGENT_MODEL` | Модель для Telegram агента (по умолчанию: haiku) | Нет |

</details>

### 4. Проверка установки

```bash
claude --version  # Должна быть последняя версия
pip show claude-agent-sdk  # Проверка установки SDK

# Тест подключения к MCP серверам (health не требует auth)
curl https://mcp.yourdomain.com/task/health
curl https://mcp.yourdomain.com/telegram/health

# Тест с API ключом
curl -H "Authorization: Bearer $MCP_API_KEY" https://mcp.yourdomain.com/task/sse
```

## Быстрый старт

```bash
# Базовое использование — создаёт проект в ./generations/my-app/
uv run python autonomous_agent_demo.py --project-dir my-app

# Указать другую директорию вывода
uv run python autonomous_agent_demo.py --generations-base ~/projects/ai --project-dir my-app

# Ограничить итерации для тестирования
uv run python autonomous_agent_demo.py --project-dir my-app --max-iterations 3

# Использовать Opus для оркестратора (более мощный, но дороже)
uv run python autonomous_agent_demo.py --project-dir my-app --model opus
```

## Как это работает

### Мультиагентная оркестрация

```
┌───────────────────────────────────────────────────────────────┐
│                  МУЛЬТИАГЕНТНАЯ АРХИТЕКТУРА                   │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│                    ┌─────────────────┐                        │
│                    │   ОРКЕСТРАТОР   │  (Haiku по умолчанию)  │
│                    │   Координирует  │                        │
│                    └────────┬────────┘                        │
│                             │                                 │
│           ┌─────────────────┼─────────────────┐               │
│           │                 │                 │               │
│      ┌────▼─────┐    ┌─────▼──────┐   ┌─────▼──────┐          │
│      │   TASK   │    │   CODING   │   │ TELEGRAM   │          │
│      │  (Haiku) │    │  (Sonnet)  │   │  (Haiku)   │          │
│      └────┬─────┘    └─────┬──────┘   └─────┬──────┘          │
│           │                │                │                 │
│      Task MCP         Playwright       Telegram MCP           │
│      Server           + Local Git         Server              │
│     (PostgreSQL)                        (Bot API)             │
│                                                               │
│     ┌──────────────────────────────────────────────┐          │
│     │          ПРОЕКТ (Изолированный Git)          │          │
│     │      GENERATIONS_BASE_PATH/project-name/     │          │
│     └──────────────────────────────────────────────┘          │
└───────────────────────────────────────────────────────────────┘
```

### Ответственность агентов

1. **Оркестратор:**
   - Читает состояние проекта из `.task_project.json`
   - Запрашивает текущий статус у Task MCP Server
   - Решает, что делать дальше
   - Делегирует специализированным агентам через Task tool
   - Координирует передачу между агентами

2. **Task Agent:**
   - Создаёт и обновляет проекты и задачи
   - Управляет переходами статусов (Todo → In Progress → Done)
   - Добавляет комментарии с деталями реализации
   - Поддерживает META issue для отслеживания сессий

3. **Coding Agent:**
   - Реализует фичи на основе задач
   - Пишет и тестирует код приложения
   - Использует Playwright для браузерного UI-тестирования
   - Валидирует ранее завершённые фичи
   - Управляет локальными git-коммитами

4. **Telegram Agent:**
   - Публикует обновления прогресса в ваш Telegram-чат
   - Уведомляет о завершении фич
   - Отправляет сводки статуса проекта

## Опции командной строки

| Опция | Описание | По умолчанию |
|-------|----------|--------------|
| `--project-dir` | Имя проекта или путь | `./autonomous_demo_project` |
| `--generations-base` | Базовая директория для всех проектов | `./generations` или `GENERATIONS_BASE_PATH` |
| `--max-iterations` | Максимум итераций агента | Без ограничений |
| `--model` | Модель оркестратора: haiku, sonnet, или opus | `haiku` или `ORCHESTRATOR_MODEL` |

## Кастомизация

### Изменение приложения

Отредактируйте `prompts/app_spec.txt` чтобы указать другое приложение для сборки.

### Изменение количества задач

Отредактируйте `prompts/initializer_task.md` чтобы изменить количество создаваемых задач.

### Изменение разрешённых команд

Отредактируйте `security.py` чтобы добавить или удалить команды из `ALLOWED_COMMANDS`.

## Структура проекта

```
your-claude-engineer/
├── autonomous_agent_demo.py  # Точка входа
├── agent.py                  # Логика сессий агента
├── client.py                 # Конфигурация Claude SDK + MCP
├── mcp_config.py             # URL MCP серверов и определения инструментов
├── security.py               # Allowlist bash-команд и валидация
├── progress.py               # Утилиты отслеживания прогресса
├── prompts.py                # Утилиты загрузки промптов
├── test_security.py          # Тесты безопасности
├── agents/
│   ├── definitions.py        # Определения агентов с конфигурацией моделей
│   └── orchestrator.py       # Запуск сессии оркестратора
├── prompts/
│   ├── app_spec.txt              # Спецификация приложения
│   ├── orchestrator_prompt.md    # Системный промпт оркестратора
│   ├── initializer_task.md       # Сообщение задачи для первой сессии
│   ├── continuation_task.md      # Сообщение задачи для продолжения
│   ├── task_agent_prompt.md      # Промпт Task субагента
│   ├── coding_agent_prompt.md    # Промпт Coding субагента
│   └── telegram_agent_prompt.md  # Промпт Telegram субагента
└── requirements.txt          # Python зависимости
```

## Структура генерируемого проекта

Проекты создаются в изолированных директориях со своими git-репозиториями:

```
generations/my-app/           # Или GENERATIONS_BASE_PATH/my-app/
├── .task_project.json        # Состояние проекта (маркер-файл)
├── app_spec.txt              # Скопированная спецификация
├── init.sh                   # Скрипт настройки окружения
├── .claude_settings.json     # Настройки безопасности
├── .git/                     # Отдельный git-репозиторий
└── [файлы приложения]        # Сгенерированный код приложения
```

## MCP серверы

MCP серверы развёрнуты отдельно — см. [AxonCode/axon-mcp](https://github.com/AxonCode/axon-mcp).

| Сервер | Транспорт | Назначение |
|--------|-----------|------------|
| **Task MCP Server** | HTTP (SSE) | Управление проектами/задачами с PostgreSQL + pgvector бэкендом |
| **Telegram MCP Server** | HTTP (SSE) | Уведомления через Telegram Bot API |
| **Playwright** | stdio | Браузерная автоматизация для UI-тестирования |

## Модель безопасности

Демо использует многоуровневую безопасность (см. `security.py` и `client.py`):

1. **OAuth 2.0 + API Key аутентификация:** Обрабатывается MCP серверами ([axon-mcp](https://github.com/AxonCode/axon-mcp))
2. **Песочница на уровне ОС:** Bash-команды выполняются в изолированном окружении
3. **Ограничения файловой системы:** Файловые операции ограничены директорией проекта
4. **Allowlist Bash:** Разрешены только определённые команды (npm, node, git, curl, rm с валидацией и т.д.)
5. **MCP-разрешения:** Инструменты явно разрешены в настройках безопасности
6. **Валидация опасных команд:** Команды типа `rm` валидируются для предотвращения удаления системных директорий

## Просмотр прогресса

**Task MCP Server:**
- Просмотр задач через прямые запросы к БД
- Наблюдение за изменениями статусов в реальном времени (Todo → In Progress → Done)
- Чтение комментариев с деталями реализации
- Проверка сводок сессий в META issue

**Telegram:**
- Получение обновлений прогресса в настроенный чат
- Уведомления о завершении фич

**Локальный Git:**
- Просмотр коммитов в директории сгенерированного проекта
- Проверка истории реализации через git log

## Устранение неполадок

**"TASK_MCP_URL not set"**
Установите `TASK_MCP_URL` в вашем `.env` файле

**"TELEGRAM_MCP_URL not set"**
Установите `TELEGRAM_MCP_URL` в вашем `.env` файле

**"Connection refused" к MCP серверам**
Проверьте, что MCP серверы запущены на VDS — см. [axon-mcp](https://github.com/AxonCode/axon-mcp)

**"Command blocked by security hook"**
Агент попытался выполнить запрещённую команду. Добавьте её в `ALLOWED_COMMANDS` в `security.py` при необходимости.

**"Telegram message failed"**
Убедитесь, что вы сначала написали боту (отправьте `/start`) и что `TELEGRAM_CHAT_ID` корректен.

**401 "unauthorized" при подключении к MCP серверам**
Убедитесь, что `MCP_API_KEY` установлен в `.env` файле. Создайте ключ через `admin_cli.py` в axon-mcp.

## Лицензия

MIT License — см. [LICENSE](LICENSE) для деталей.
